<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Query Language Playground</title>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: #2e3440;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
        }

        .loading {
            background: #88c0d0;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ready {
            background: #a3be8c;
        }

        .error-banner {
            background: #bf616a;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .editor-section, .output-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #2e3440;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .btn {
            background: #5e81ac;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #4c6a92;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            background: #4c566a;
            cursor: not-allowed;
        }

        .CodeMirror {
            height: 400px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        .output {
            height: 400px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #272822;
            color: #f8f8f2;
        }

        .examples {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .examples h3 {
            margin-bottom: 15px;
            color: #2e3440;
        }

        .example-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .example-btn {
            background: #eceff4;
            border: 1px solid #d8dee9;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #d8dee9;
        }

        .error {
            color: #bf616a;
            padding: 10px;
            background: #3b4252;
            border-radius: 4px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PromQL Flow Query Language Playground</h1>
            <p>A PromQL extension with pipeline operators and let bindings</p>
        </header>

        <div id="status" class="loading">Loading WebAssembly transpiler...</div>

        <div class="editor-container">
            <div class="editor-section">
                <div class="section-header">
                    <h2>PromQL Flow Query</h2>
                    <div>
                        <button id="share-btn" class="btn">Share Link</button>
                        <button id="format-btn" class="btn" disabled>Format</button>
                    </div>
                </div>
                <textarea id="flow-editor"></textarea>
            </div>

            <div class="output-section">
                <div class="section-header">
                    <h2>Transpiled PromQL</h2>
                    <button id="copy-btn" class="btn">Copy</button>
                </div>
                <div id="promql-output" class="output"></div>
            </div>
        </div>

        <div class="examples">
            <h3>Examples:</h3>
            <div class="example-list">
                <button class="example-btn" data-example="simple">Simple Selector</button>
                <button class="example-btn" data-example="pipeline">Pipeline</button>
                <button class="example-btn" data-example="aggregation">Aggregation</button>
                <button class="example-btn" data-example="let">Let Expression</button>
                <button class="example-btn" data-example="complex">Complex Query</button>
                <button class="example-btn" data-example="binop_filter">Binary filter</button>
                <button class="example-btn" data-example="binop">Binary operation</button>
            </div>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>

    <!-- Load WASM runtime and module -->
    <script src="web/wasm-runtime.js"></script>
    <script src="web/flow-wasm.js"></script>

    <script>
        // CodeMirror mode for Flow Query Language
        CodeMirror.defineMode("flow", function(config, parserConfig) {
            const keywords = {
                "let": true,
                "in": true,
                "by": true,
                "without": true
            };

            const aggregations = {
                "sum": true,
                "min": true,
                "max": true,
                "avg": true,
                "stddev": true,
                "stdvar": true,
                "count": true,
                "count_values": true,
                "bottomk": true,
                "topk": true,
                "quantile": true
            };

            const functions = {
                "rate": true,
                "irate": true,
                "increase": true,
                "delta": true,
                "deriv": true
            };

            function tokenBase(stream, state) {
                if (stream.eatSpace()) return null;

                if (stream.match(/^#.*/)) {
                    return "comment";
                }

                const ch = stream.next();
                if (ch === '"' || ch === "'" || ch === '`') {
                    state.tokenize = tokenString(ch);
                    return state.tokenize(stream, state);
                }

                if (/[0-9]/.test(ch)) {
                    stream.match(/^[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?/);
                    if (stream.match(/[smhdwy]/)) {
                        return "number";
                    }
                    return "number";
                }

                if (ch === '|') {
                    return "operator";
                }
                if (/[\+\-\*\/]/.test(ch)) {
                    return "operator";
                }
                if (ch === '=' && stream.peek() === '~') {
                    stream.next();
                    return "operator";
                }
                if (ch === '!' && stream.peek() === '~') {
                    stream.next();
                    return "operator";
                }
                if (ch === '!' && stream.peek() === '=') {
                    stream.next();
                    return "operator";
                }
                if (ch === '=') {
                    return "operator";
                }

                if (/[\{\}\[\]\(\),]/.test(ch)) {
                    return "bracket";
                }

                if (/[a-zA-Z_:]/.test(ch)) {
                    stream.match(/^[a-zA-Z0-9_:]*/);
                    const word = stream.current();

                    if (keywords.hasOwnProperty(word)) {
                        return "keyword";
                    }
                    if (aggregations.hasOwnProperty(word)) {
                        return "builtin";
                    }
                    if (functions.hasOwnProperty(word)) {
                        return "atom";
                    }

                    return "variable";
                }

                return null;
            }

            function tokenString(quote) {
                return function(stream, state) {
                    let escaped = false, next, end = false;
                    while ((next = stream.next()) != null) {
                        if (next === quote && !escaped) {
                            end = true;
                            break;
                        }
                        escaped = !escaped && next === "\\";
                    }
                    if (end || !escaped) state.tokenize = null;
                    return "string";
                };
            }

            return {
                startState: function() {
                    return {
                        tokenize: null
                    };
                },

                token: function(stream, state) {
                    if (state.tokenize) {
                        return state.tokenize(stream, state);
                    }
                    return tokenBase(stream, state);
                },

                lineComment: "#"
            };
        });

        CodeMirror.defineMIME("text/x-flow", "flow");

        // Initialize the application
        let editor;
        let outputDiv;
        let wasmReady = false;

        const examples = {
            simple: 'http_requests_total{method="POST"}',
            pipeline: 'http_requests_total | rate 5m | sum by (endpoint)',
            aggregation: 'http_requests_total{job="api"} | rate 1m | sum by (method, status)',
            let: `let
  req_get = http_requests_total{method="GET"} | rate 5m | sum by (endpoint),
  req_total = http_requests_total | rate 5m | sum by (endpoint)
in req_get / req_total`,
            complex: `let
  errors = http_requests_total{status=~"5.."} | rate 5m,
  total = http_requests_total | rate 5m
in (errors / total) * 100`,
            binop_filter: `http_requests_total{status=~"5.."} | rate 5m | > 10`,
            binop: `http_requests_total{status=~"5.."} | rate 5m | * 10`
        };

        // Load WASM from the global variable set by flow-wasm.js
        async function loadWasm() {
            try {
                if (typeof FLOW_WASM_BASE64 === 'undefined') {
                    throw new Error('WASM module not found. Make sure flow-wasm.js is loaded.');
                }

                // Decode base64 to bytes
                const binaryString = atob(FLOW_WASM_BASE64.trim());
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const go = new Go();
                const result = await WebAssembly.instantiate(bytes, go.importObject);
                go.run(result.instance);

                wasmReady = true;
                document.getElementById('status').textContent = 'Ready! Using WebAssembly transpiler.';
                document.getElementById('status').classList.remove('loading');
                document.getElementById('status').classList.add('ready');
                document.getElementById('format-btn').disabled = false;

                // Initial transpilation
                transpile();
            } catch (error) {
                console.error('Failed to load WASM:', error);
                document.getElementById('status').textContent = 'Failed to load WebAssembly: ' + error.message;
                document.getElementById('status').classList.remove('loading');
                document.getElementById('status').classList.add('error-banner');
            }
        }

        function transpile() {
            if (!wasmReady) return;

            const input = editor.getValue();
            const result = window.transpileFlow(input);

            if (result.success) {
                outputDiv.textContent = result.result;
                outputDiv.classList.remove('error');
            } else {
                outputDiv.innerHTML = `<div class="error">Error: ${escapeHtml(result.error)}</div>`;
                outputDiv.classList.add('error');
            }
        }

        function formatQuery() {
            const value = editor.getValue();
            let formatted = value
                .replace(/\s+/g, ' ')
                .trim();

            formatted = formatted.replace(/let\s+/g, 'let\n  ');
            formatted = formatted.replace(/,\s*(\w+\s*=)/g, ',\n  $1');
            formatted = formatted.replace(/\s+in\s+/g, '\nin ');
            formatted = formatted.replace(/\s*\|\s*/g, ' | ');

            editor.setValue(formatted);
        }

        function copyOutput() {
            const text = outputDiv.textContent;

            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);

            textarea.select();
            document.execCommand('copy');

            document.body.removeChild(textarea);

            const copyBtn = document.getElementById('copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        }

        function shareQuery() {
            // Ensure URL is up to date
            updateURL(editor.getValue());

            // Copy the current URL to clipboard
            const url = window.location.href;

            // Use the newer Clipboard API if available, fall back to execCommand
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    updateShareButton('Link Copied!');
                }).catch(() => {
                    // Fall back to execCommand
                    copyToClipboardFallback(url);
                });
            } else {
                copyToClipboardFallback(url);
            }
        }

        function copyToClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);

            textarea.select();
            try {
                document.execCommand('copy');
                updateShareButton('Link Copied!');
            } catch (err) {
                console.error('Failed to copy:', err);
                updateShareButton('Copy Failed');
            }

            document.body.removeChild(textarea);
        }

        function updateShareButton(text) {
            const shareBtn = document.getElementById('share-btn');
            const originalText = shareBtn.textContent;
            shareBtn.textContent = text;
            setTimeout(() => {
                shareBtn.textContent = originalText;
            }, 2000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Function to update URL with query parameter
        function updateURL(query) {
            const params = new URLSearchParams(window.location.search);
            if (query) {
                params.set('q', query);
            } else {
                params.delete('q');
            }

            const newURL = window.location.pathname +
                (params.toString() ? '?' + params.toString() : '') +
                window.location.hash;

            // Update URL without reloading the page
            window.history.replaceState({}, '', newURL);
        }

        // Function to get query from URL
        function getQueryFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('q');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('flow-editor');
            editor = CodeMirror.fromTextArea(textarea, {
                mode: 'flow',
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                indentWithTabs: false
            });

            // Check if there's a query in the URL
            const urlQuery = getQueryFromURL();
            if (urlQuery) {
                editor.setValue(urlQuery);
            } else {
                editor.setValue(examples.pipeline);
            }

            outputDiv = document.getElementById('promql-output');

            document.getElementById('format-btn').addEventListener('click', formatQuery);
            document.getElementById('copy-btn').addEventListener('click', copyOutput);
            document.getElementById('share-btn').addEventListener('click', shareQuery);

            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const example = this.getAttribute('data-example');
                    if (examples[example]) {
                        editor.setValue(examples[example]);
                        transpile();
                    }
                });
            });

            let transpileTimeout;
            editor.on('change', function() {
                clearTimeout(transpileTimeout);
                transpileTimeout = setTimeout(transpile, 500);
            });

            // Load WASM
            loadWasm();
        });
    </script>
</body>
</html>